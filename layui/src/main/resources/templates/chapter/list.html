<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>layui</title>
    <meta content="webkit" name="renderer">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport">
    <link href="/layui-style/lib/layui-v2.6.3/css/layui.css" media="all" rel="stylesheet">
    <link href="/layui-style/css/public.css" media="all" rel="stylesheet">
</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main">
        <script id="toolbarDemo" type="text/html">
            <div class="layui-btn-container">
                <button class="layui-btn layui-btn-sm" lay-event="addFatherChapter"><i class="layui-icon">&#xe654;</i>添加
                </button>
            </div>
        </script>

        <table id="menu" class="layui-hide" lay-filter="menu"></table>

    </div>
</div>
<script charset="utf-8" src="/layui-style/lib/layui-v2.6.3/layui.js"></script>
<script src="/layui-style/lib/jquery-3.4.1/jquery-3.4.1.min.js"></script>
<script>
    let course_id = [[${course_id}]]
    layui.config({base: '/layui-style/js/lay-module/'})
        .extend({treetable: "/treetable-lay/treetable"})
        .use(['treetable', 'table', 'layer'], function () {
            var $ = layui.jquery;
            var table = layui.table;
            var layer = layui.layer;
            var treetable = layui.treetable;
            //渲染表格
            var renderTable = function () {
                layer.load(2); //加载层
                treetable.render({
                    height: 'full-160',
                    id: 'menu',
                    method: 'post',
                    treeColIndex: 1, //树形图标显示在第几列
                    treeSpid: '0', //最上级的父级id
                    treeIdName: 'section_id', //id字段的名称
                    treePidName: 'parent_id', //父级节点字段
                    treeDefaultClose: false, //是否默认折叠
                    treeLinkage: false, //父级展开时是否自动展开所有子级
                    elem: '#menu', //表格id
                    url: '/chapter/getChapter/' + course_id,
                    toolbar: '#toolbarDemo',
                    page: false,
                    cols: [
                        [
                            {type: 'radio'},
                            {field: 'section_name', title: '章节名称'},
                            {field: 'remark', title: '备注'},
                            {
                                title: '操作', templet: function (d) {
                                    if (d.parent_id === 0) {
                                        return '<div><a style="display:inline-block;height:38px;line-height:38px;padding:0 18px;border:1px solid transparent;background-color:#009688;color:#fff;white-space:nowrap;text-align:center;font-size:14px;border-radius:2px;cursor:pointer;height:22px;line-height:22px;padding:0 5px;font-size:12px" lay-event="addSonChapter">新增</a>' +
                                            '<a style="display:inline-block;height:38px;line-height:38px;padding:0 18px;border:1px solid transparent;background-color:#009688;color:#fff;white-space:nowrap;text-align:center;font-size:14px;border-radius:2px;cursor:pointer;background-color:#1E9FFF;height:22px;line-height:22px;padding:0 5px;font-size:12px" lay-event="editChapter">编辑</a>' +
                                            '<a style="display:inline-block;height:38px;line-height:38px;padding:0 18px;border:1px solid transparent;background-color:#009688;color:#fff;white-space:nowrap;text-align:center;font-size:14px;border-radius:2px;cursor:pointer;background-color:#FF5722;height:22px;line-height:22px;padding:0 5px;font-size:12px" lay-event="deleteChapter">删除</a></div>'
                                    } else {
                                        return '<div><a style="display:inline-block;height:38px;line-height:38px;padding:0 18px;border:1px solid transparent;background-color:#009688;color:#fff;white-space:nowrap;text-align:center;font-size:14px;border-radius:2px;cursor:pointer;background-color:#1E9FFF;height:22px;line-height:22px;padding:0 5px;font-size:12px" lay-event="editChapter">编辑</a>' +
                                            '<a style="display:inline-block;height:38px;line-height:38px;padding:0 18px;border:1px solid transparent;background-color:#009688;color:#fff;white-space:nowrap;text-align:center;font-size:14px;border-radius:2px;cursor:pointer;background-color:#FF5722;height:22px;line-height:22px;padding:0 5px;font-size:12px" lay-event="deleteChapter">删除</a></div>'
                                    }
                                }, align: "center"
                            }
                        ]
                    ],
                    //数据渲染完的回调
                    done: function () {
                        //关闭加载
                        layer.closeAll('loading');
                    }
                })
            };
            renderTable();

            //父章节新增
            table.on('toolbar(menu)', function (obj) {
                var checkStatus = table.checkStatus(obj.config.id);
                switch (obj.event) {
                    case 'addFatherChapter':
                        var index = layer.open({
                            title: '添加父章节',
                            type: 2,
                            shade: 0.2,
                            maxmin: true,
                            shadeClose: true,
                            area: ['100%', '100%'],
                            content: '/chapter/table/addFather/' + course_id,
                        });
                        $(window).on("resize", function () {
                            layer.full(index);
                        });
                        break;
                }
            });
            //子章节新增
            /**
             * toolbar监听事件
             */
            table.on('tool(menu)', function (obj) {

                if (obj.event === 'addSonChapter') {  // 监听添加操作
                    console.log(obj)
                    var index = layer.open({
                        title: '添加',
                        type: 2,
                        shade: 0.2,
                        maxmin: true,
                        shadeClose: true,
                        area: ['100%', '100%'],
                        content: '/chapter/table/addSon/' + obj.data.section_id + '/' + course_id,
                    });
                    $(window).on("resize", function () {
                        layer.full(index);
                    });
                } else if (obj.event === 'deleteChapter') {  // 监听删除操作
                    if (obj.data.parent_id === 0) { // 判断父子节点
                        layer.confirm('真的删除行么', function (index) {
                            $.ajax({
                                url: '/chapter/delFather/' + obj.data.section_id,
                                type: 'get',
                                success: function (result) {
                                    layer.msg("父章节删除成功！");
                                    window.location = "/chapter/list/" + course_id
                                }
                            });
                            layer.close(index);
                        });
                    } else {
                        layer.confirm('真的删除这一行么', function (index) {
                            $.ajax({
                                url: '/chapter/delSon/' + obj.data.section_id,
                                type: 'get',
                                success: function (result) {
                                    layer.msg("子章节删除成功！");
                                    window.location = "/chapter/list/" + course_id
                                }
                            });
                            layer.close(index);
                        });
                    }
                } else if (obj.event === 'editChapter') { // 监听编辑操作
                    if (obj.data.parent_id === 0) { // 判断父子章节
                        var index = layer.open({
                            title: '编辑父章节',
                            type: 2,
                            shade: 0.2,
                            maxmin: true,
                            section_id: obj.data.section_id,
                            shadeClose: true,
                            area: ['100%', '100%'],
                            content: '/chapter/table/editFather?section_id=' + obj.data.section_id,
                        });
                    } else {
                        var index = layer.open({
                            title: '编辑子章节',
                            type: 2,
                            shade: 0.2,
                            maxmin: true,
                            section_id: obj.data.section_id,
                            shadeClose: true,
                            area: ['100%', '100%'],
                            content: '/chapter/table/editSon?section_id=' + obj.data.section_id,
                        });
                    }

                    $(window).on("resize", function () {
                        layer.full(index);
                    });
                }
            });
        });
</script>

</body>
</html>